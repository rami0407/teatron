<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ - Ù…Ø³Ø±Ø­ Ø§Ù„Ø¯Ù…Ù‰</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <style>
        .students-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .students-table th,
        .students-table td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }

        .students-table th {
            background: #f8f9fa;
            color: #555;
            font-weight: 700;
        }

        .coupon-badge {
            background: #fff3cd;
            color: #856404;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav>
        <div class="container">
            <div class="logo">
                <span class="logo-icon">ğŸ“</span>
                <span>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø¹Ù„Ù…</span>
            </div>
            <div class="nav-right">
                <span class="user-greeting">Ù…Ø±Ø­Ø¨Ø§Ù‹, <strong id="userName">Ø§Ù„Ù…Ø¹Ù„Ù…</strong></span>
                <button id="logoutBtn" class="btn btn-outline btn-sm">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <ul class="sidebar-menu">
                <li class="menu-item">
                    <a href="dashboard.html">
                        <span class="menu-icon">ğŸ“¥</span>
                        <span>ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙˆØ§Ø±Ø¯</span>
                    </a>
                </li>
                <li class="menu-item active">
                    <a href="students.html">
                        <span class="menu-icon">ğŸ‘¥</span>
                        <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</span>
                    </a>
                </li>
            </ul>
        </aside>

        <!-- Main Dashboard -->
        <main class="dashboard-main">
            <div class="dashboard-header">
                <h1>ğŸ‘¥ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h1>
                <p class="text-muted">Ù…ØªØ§Ø¨Ø¹Ø© Ù†Ø´Ø§Ø· Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ±ØµÙŠØ¯ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª</p>
            </div>

            <div class="table-responsive">
                <table class="students-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                            <th>Ø±ØµÙŠØ¯ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª ğŸŸï¸</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</th>
                        </tr>
                    </thead>
                    <tbody id="studentsList">
                        <tr>
                            <td colspan="4" style="text-align:center; padding:30px;">
                                <div class="spinner" style="margin:0 auto;"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </main>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Scripts -->
    <script src="../js/firebase-config.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const authData = await checkAuth('teacher');
                document.getElementById('userName').textContent = authData.userData.name;

                loadStudents();

            } catch (error) {
                console.error(error);
            }
        });

        async function loadStudents() {
            const list = document.getElementById('studentsList');

            try {
                const snapshot = await db.collection('users')
                    .where('role', '==', 'student')
                    .orderBy('createdAt', 'desc')
                    .get();

                if (snapshot.empty) {
                    list.innerHTML = '<tr><td colspan="4" style="text-align:center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø³Ø¬Ù„ÙŠÙ† Ø¨Ø¹Ø¯.</td></tr>';
                    return;
                }

                list.innerHTML = snapshot.docs.map(doc => {
                    const student = doc.data();
                    const date = student.createdAt ? new Date(student.createdAt.toMillis()).toLocaleDateString('ar-EG') : '-';

                    return `
                        <tr>
                            <td>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <div style="background:#eee; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;">ğŸ‘¤</div>
                                    <strong>${student.name}</strong>
                                </div>
                            </td>
                            <td>${student.email}</td>
                            <td>
                                <span class="coupon-badge">
                                    ${student.points || 0} ğŸŸï¸
                                </span>
                            </td>
                            <td>${date}</td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading students:', error);

                // Fallback for Index error
                if (error.message.includes('index')) {
                    const snapshot = await db.collection('users').where('role', '==', 'student').get();
                    // Client side sort
                    const students = snapshot.docs.map(d => d.data()).sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

                    list.innerHTML = students.map(student => {
                        const date = student.createdAt ? new Date(student.createdAt.toMillis()).toLocaleDateString('ar-EG') : '-';
                        return `
                        <tr>
                            <td>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <div style="background:#eee; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;">ğŸ‘¤</div>
                                    <strong>${student.name}</strong>
                                </div>
                            </td>
                            <td>${student.email}</td>
                            <td><span class="coupon-badge">${student.points || 0} ğŸŸï¸</span></td>
                            <td>${date}</td>
                        </tr>`;
                    }).join('');
                } else {
                    list.innerHTML = '<tr><td colspan="4" style="color:red; text-align:center;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
                }
            }
        }

        document.getElementById('logoutBtn').addEventListener('click', () => logout());
    </script>
</body>

</html>